import logging
from datetime import datetime, timedelta
from aiogram import types

from database import Database
from api_client import BasketballAPI
from keyboards import get_main_keyboard, get_settings_keyboard

logging.basicConfig(level=logging.INFO)

db = None
api_client = None


def init_handlers(database: Database, api: BasketballAPI):
    global db, api_client
    db = database
    api_client = api


async def start_command(message: types.Message):
    try:
        await message.answer(
            "üèÄ –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –±–∞—Å–∫–µ—Ç–±–æ–ª—å–Ω—ã—Ö –º–∞—Ç—á–µ–π NBA.\n\n"
            "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:\n"
            "‚Ä¢ üéØ –ò–≥—Ä—ã —Å–µ–≥–æ–¥–Ω—è - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
            "‚Ä¢ üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏–≥—Ä - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é\n"
            "‚Ä¢ üèÄ –ú–æ—è –∫–æ–º–∞–Ω–¥–∞ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ\n"
            "‚Ä¢ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=get_main_keyboard()
        )
    except Exception as e:
        logging.error(f"Error in start_command: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")


async def games_today(message: types.Message):
    try:
        await message.answer("üìä –ó–∞–≥—Ä—É–∂–∞—é –∏–≥—Ä—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è...")
        data = api_client.get_games_today()

        if not data or 'data' not in data or len(data['data']) == 0:
            await message.answer("–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∏–≥—Ä –Ω–µ—Ç! üèÄ")
            return

        response = "üèÄ –ò–≥—Ä—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:\n\n"

        for game in data['data'][:5]:  # –û–≥—Ä–∞–Ω–∏—á–∏–º 5 –∏–≥—Ä–∞–º–∏
            home_team = game['home_team']['full_name']
            visitor_team = game['visitor_team']['full_name']
            home_score = game['home_team_score']
            visitor_score = game['visitor_team_score']
            status = game['status']

            if status == 'Final' and home_score is not None:
                result = f"üèÅ {home_score} - {visitor_score}"
            elif status == 'In Progress':
                result = f"‚ñ∂Ô∏è {home_score or '0'} - {visitor_score or '0'}"
            else:
                result = "‚è≥ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞"

            response += f"‚Ä¢ {home_team} vs {visitor_team}\n"
            response += f"  {result} ({status})\n\n"

        await message.answer(response)

    except Exception as e:
        logging.error(f"Error in games_today: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.")


async def my_team(message: types.Message):
    try:
        settings = db.get_user_settings(message.from_user.id)

        if not settings or not settings['favorite_team']:
            await message.answer(
                "‚ùå –£ –≤–∞—Å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –ª—é–±–∏–º–∞—è –∫–æ–º–∞–Ω–¥–∞.\n\n"
                "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí ‚≠ê –í—ã–±—Ä–∞—Ç—å –ª—é–±–∏–º—É—é –∫–æ–º–∞–Ω–¥—É",
                reply_markup=get_main_keyboard()
            )
            return

        team_name = settings['favorite_team_name'] or "–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞"
        await message.answer(f"‚≠ê –í–∞—à–∞ –ª—é–±–∏–º–∞—è –∫–æ–º–∞–Ω–¥–∞: {team_name}\n\n"
                             f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é 'üéØ –ò–≥—Ä—ã —Å–µ–≥–æ–¥–Ω—è' –∏–ª–∏ 'üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏–≥—Ä' "
                             f"–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–∞—Ç—á–µ–π.",
                             reply_markup=get_main_keyboard())

    except Exception as e:
        logging.error(f"Error in my_team: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–∞–Ω–¥–µ.")
