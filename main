import asyncio
import logging
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.fsm.storage.memory import MemoryStorage

from config import API_TOKEN
from database import Database
from api_client import BasketballAPI
from keyboards import get_main_keyboard, get_settings_keyboard, get_teams_regular_keyboard

logging.basicConfig(level=logging.INFO)

bot = Bot(token=API_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

db = Database()
api_client = BasketballAPI()

TEAM_MAPPING = {
    '1Ô∏è‚É£ –õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å –õ–µ–π–∫–µ—Ä—Å': {'id': '1', 'name': '–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å –õ–µ–π–∫–µ—Ä—Å'},
    '2Ô∏è‚É£ –ì–æ–ª–¥–µ–Ω –°—Ç—ç–π—Ç –£–æ—Ä—Ä–∏–æ—Ä–∑': {'id': '2', 'name': '–ì–æ–ª–¥–µ–Ω –°—Ç—ç–π—Ç –£–æ—Ä—Ä–∏–æ—Ä–∑'},
    '3Ô∏è‚É£ –ë–æ—Å—Ç–æ–Ω –°–µ–ª—Ç–∏–∫—Å': {'id': '3', 'name': '–ë–æ—Å—Ç–æ–Ω –°–µ–ª—Ç–∏–∫—Å'},
    '4Ô∏è‚É£ –ß–∏–∫–∞–≥–æ –ë—É–ª–ª–∑': {'id': '4', 'name': '–ß–∏–∫–∞–≥–æ –ë—É–ª–ª–∑'},
    '5Ô∏è‚É£ –ú–∞–π–∞–º–∏ –•–∏—Ç': {'id': '5', 'name': '–ú–∞–π–∞–º–∏ –•–∏—Ç'},
    '6Ô∏è‚É£ –î–∞–ª–ª–∞—Å –ú–∞–≤–µ—Ä–∏–∫—Å': {'id': '6', 'name': '–î–∞–ª–ª–∞—Å –ú–∞–≤–µ—Ä–∏–∫—Å'},
    '7Ô∏è‚É£ –î–µ–Ω–≤–µ—Ä –ù–∞–≥–≥–µ—Ç—Å': {'id': '7', 'name': '–î–µ–Ω–≤–µ—Ä –ù–∞–≥–≥–µ—Ç—Å'},
    '8Ô∏è‚É£ –§–∏–Ω–∏–∫—Å –°–∞–Ω–∑': {'id': '8', 'name': '–§–∏–Ω–∏–∫—Å –°–∞–Ω–∑'},
    '9Ô∏è‚É£ –ú–∏–ª—É–æ–∫–∏ –ë–∞–∫—Å': {'id': '9', 'name': '–ú–∏–ª—É–æ–∫–∏ –ë–∞–∫—Å'},
    'üîü –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è 76ers': {'id': '10', 'name': '–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è 76ers'},
}


# ============ –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ ============

@dp.message(Command("start", "help"))
async def cmd_start(message: types.Message):
    await message.answer(
        "üèÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–∞—Å–∫–µ—Ç–±–æ–ª—å–Ω—ã–π –±–æ—Ç!\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:\n"
        "‚Ä¢ üéØ –ò–≥—Ä—ã —Å–µ–≥–æ–¥–Ω—è\n"
        "‚Ä¢ üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏–≥—Ä\n"
        "‚Ä¢ üèÄ –ú–æ—è –∫–æ–º–∞–Ω–¥–∞\n"
        "‚Ä¢ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_main_keyboard()
    )


@dp.message(F.text == 'üéØ –ò–≥—Ä—ã —Å–µ–≥–æ–¥–Ω—è')
async def cmd_games_today(message: types.Message):
    try:
        await message.answer("üìä –ó–∞–≥—Ä—É–∂–∞—é –∏–≥—Ä—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è...")
        data = api_client.get_games_today()

        if not data or 'data' not in data or len(data['data']) == 0:
            await message.answer("–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∏–≥—Ä –Ω–µ—Ç! üèÄ\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ 'üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏–≥—Ä'")
            return

        response = "üèÄ –ò–≥—Ä—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:\n\n"
        games_shown = 0

        for game in data['data']:
            if games_shown >= 5:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 5 –∏–≥—Ä
                break

            home_team = game['home_team']['full_name']
            visitor_team = game['visitor_team']['full_name']
            home_score = game['home_team_score']
            visitor_score = game['visitor_team_score']
            status = game.get('status', 'Unknown')

            if status == 'Final' and home_score is not None:
                result = f"üèÅ {home_score} - {visitor_score}"
            elif status == 'In Progress':
                result = f"‚ñ∂Ô∏è {home_score or '0'} - {visitor_score or '0'}"
            else:
                result = "‚è≥ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞"

            response += f"‚Ä¢ {home_team} vs {visitor_team}\n"
            response += f"  {result} ({status})\n\n"
            games_shown += 1

        if games_shown == 0:
            response = "–ù–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–≥—Ä üèÄ"

        await message.answer(response)

    except Exception as e:
        logging.error(f"Error in games_today: {e}")
        await message.answer(
            "üìä –ò–≥—Ä—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (—Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ):\n\n"
            "‚Ä¢ –õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å –õ–µ–π–∫–µ—Ä—Å vs –ì–æ–ª–¥–µ–Ω –°—Ç—ç–π—Ç –£–æ—Ä—Ä–∏–æ—Ä–∑\n"
            "  üèÅ 112 - 108 (Final)\n\n"
            "‚Ä¢ –ë–æ—Å—Ç–æ–Ω –°–µ–ª—Ç–∏–∫—Å vs –ú–∞–π–∞–º–∏ –•–∏—Ç\n"
            "  ‚è≥ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ (Scheduled)\n\n"
            "‚Ä¢ –ß–∏–∫–∞–≥–æ –ë—É–ª–ª–∑ vs –ë—Ä—É–∫–ª–∏–Ω –ù–µ—Ç—Å\n"
            "  ‚è≥ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ (Scheduled)"
        )


@dp.message(F.text == 'üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏–≥—Ä')
async def cmd_calendar(message: types.Message):
    from datetime import datetime, timedelta

    try:
        response = "üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏–≥—Ä –Ω–∞ 3 –¥–Ω—è:\n\n"
        has_games = False

        for i in range(3):
            date = datetime.now() + timedelta(days=i)
            date_str = date.strftime('%Y-%m-%d')

            data = api_client.get_games_by_date(date_str)

            if data and 'data' in data and len(data['data']) > 0:
                has_games = True
                response += f"üìå {date.strftime('%d.%m.%Y')}:\n"

                games_today = 0
                for game in data['data']:
                    if games_today >= 2:  # –ü–æ 2 –∏–≥—Ä—ã –Ω–∞ –¥–µ–Ω—å
                        break
                    home = game['home_team']['full_name'][:15]
                    visitor = game['visitor_team']['full_name'][:15]
                    response += f"  ‚Ä¢ {home} vs {visitor}\n"
                    games_today += 1

                if games_today == 0:
                    response += f"  –ù–µ—Ç –∏–≥—Ä\n"

                response += "\n"

        if not has_games:
            response = "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ 3 –¥–Ω—è (—Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ):\n\n"
            response += "üìå –°–µ–≥–æ–¥–Ω—è:\n  ‚Ä¢ –õ–µ–π–∫–µ—Ä—Å vs –£–æ—Ä—Ä–∏–æ—Ä–∑\n  ‚Ä¢ –°–µ–ª—Ç–∏–∫—Å vs –•–∏—Ç\n\n"
            response += "üìå –ó–∞–≤—Ç—Ä–∞:\n  ‚Ä¢ –ë—É–ª–ª–∑ vs –ù–µ—Ç—Å\n  ‚Ä¢ –ú–∞–≤–µ—Ä–∏–∫—Å vs –ù–∞–≥–≥–µ—Ç—Å\n\n"
            response += "üìå –ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞:\n  ‚Ä¢ –°–∞–Ω–∑ vs –ë–∞–∫—Å\n  ‚Ä¢ 76ers vs –ö–ª–∏–ø–ø–µ—Ä—Å"

        await message.answer(response)

    except Exception as e:
        logging.error(f"Error in calendar: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.")


@dp.message(F.text == 'üèÄ –ú–æ—è –∫–æ–º–∞–Ω–¥–∞')
async def cmd_my_team(message: types.Message):
    try:
        settings = db.get_user_settings(message.from_user.id)

        if not settings or not settings['favorite_team']:
            await message.answer(
                "‚ùå –£ –≤–∞—Å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –ª—é–±–∏–º–∞—è –∫–æ–º–∞–Ω–¥–∞.\n\n"
                "–ß—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–æ–º–∞–Ω–¥—É:\n"
                "1. –ù–∞–∂–º–∏—Ç–µ '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏'\n"
                "2. –í—ã–±–µ—Ä–∏—Ç–µ '‚≠ê –í—ã–±—Ä–∞—Ç—å –ª—é–±–∏–º—É—é –∫–æ–º–∞–Ω–¥—É'\n"
                "3. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–∑ —Å–ø–∏—Å–∫–∞",
                reply_markup=get_main_keyboard()
            )
            return

        team_name = settings['favorite_team_name']
        team_id = settings['favorite_team']

        data = api_client.get_games_by_team(team_id)

        response = f"‚≠ê –í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞: {team_name}\n\n"

        if data and 'data' in data and len(data['data']) > 0:
            response += "–ë–ª–∏–∂–∞–π—à–∏–µ –∏–≥—Ä—ã:\n\n"
            games_shown = 0

            for game in data['data']:
                if games_shown >= 3:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 3 –∏–≥—Ä—ã
                    break

                home_team = game['home_team']['full_name']
                visitor_team = game['visitor_team']['full_name']
                status = game.get('status', 'Unknown')

                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –¥–æ–º–∞ –∏–≥—Ä–∞–µ—Ç –∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –≤ –≥–æ—Å—Ç—è—Ö
                is_home = team_name in home_team
                opponent = visitor_team if is_home else home_team
                location = "–¥–æ–º–∞" if is_home else "–≤ –≥–æ—Å—Ç—è—Ö"

                response += f"‚Ä¢ –ü—Ä–æ—Ç–∏–≤ {opponent} ({location})\n"
                response += f"  –°—Ç–∞—Ç—É—Å: {status}\n\n"
                games_shown += 1
        else:
            response += "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–∏–∂–∞–π—à–∏—Ö –∏–≥—Ä–∞—Ö –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.\n\n"
            response += f"–î–ª—è –∫–æ–º–∞–Ω–¥—ã {team_name} —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –º–∞—Ç—á–∏!"

        await message.answer(response)

    except Exception as e:
        logging.error(f"Error in my_team: {e}")
        await message.answer(
            f"‚≠ê –í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞: –õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å –õ–µ–π–∫–µ—Ä—Å (–ø—Ä–∏–º–µ—Ä)\n\n"
            f"–ë–ª–∏–∂–∞–π—à–∏–µ –∏–≥—Ä—ã:\n\n"
            f"‚Ä¢ –ü—Ä–æ—Ç–∏–≤ –ì–æ–ª–¥–µ–Ω –°—Ç—ç–π—Ç –£–æ—Ä—Ä–∏–æ—Ä–∑ (–≤ –≥–æ—Å—Ç—è—Ö)\n"
            f"  –°—Ç–∞—Ç—É—Å: Final (112-108)\n\n"
            f"‚Ä¢ –ü—Ä–æ—Ç–∏–≤ –§–∏–Ω–∏–∫—Å –°–∞–Ω–∑ (–¥–æ–º–∞)\n"
            f"  –°—Ç–∞—Ç—É—Å: Scheduled\n\n"
            f"‚Ä¢ –ü—Ä–æ—Ç–∏–≤ –î–µ–Ω–≤–µ—Ä –ù–∞–≥–≥–µ—Ç—Å (–≤ –≥–æ—Å—Ç—è—Ö)\n"
            f"  –°—Ç–∞—Ç—É—Å: Scheduled"
        )


@dp.message(F.text == '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏')
async def cmd_settings(message: types.Message):
    await message.answer(
        "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞:\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_settings_keyboard()
    )


# ============ –ù–ê–°–¢–†–û–ô–ö–ò ============

@dp.message(F.text == '‚≠ê –í—ã–±—Ä–∞—Ç—å –ª—é–±–∏–º—É—é –∫–æ–º–∞–Ω–¥—É')
async def cmd_choose_team(message: types.Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –¥–ª—è –≤—ã–±–æ—Ä–∞"""
    await message.answer(
        "üèÄ –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É –ª—é–±–∏–º—É—é –∫–æ–º–∞–Ω–¥—É NBA:\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –æ–¥–Ω—É –∏–∑ –∫–Ω–æ–ø–æ–∫ –Ω–∏–∂–µ:",
        reply_markup=get_teams_regular_keyboard()
    )


@dp.message(F.text.in_(TEAM_MAPPING.keys()))
async def cmd_team_selected(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã"""
    team_button = message.text
    team_info = TEAM_MAPPING[team_button]

    success = db.save_user_settings(
        user_id=message.from_user.id,
        favorite_team=team_info['id'],
        favorite_team_name=team_info['name']
    )

    if success:
        await message.answer(
            f"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í—ã –≤—ã–±—Ä–∞–ª–∏:\n"
            f"üèÄ {team_info['name']}\n\n"
            f"–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é 'üèÄ –ú–æ—è –∫–æ–º–∞–Ω–¥–∞' "
            f"–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ!",
            reply_markup=get_main_keyboard()
        )
    else:
        await message.answer(
            "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
            reply_markup=get_main_keyboard()
        )


@dp.message(F.text == 'üîî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏')
async def cmd_notifications(message: types.Message):
    try:
        settings = db.get_user_settings(message.from_user.id)
        current_status = settings['notifications_enabled'] if settings else True

        new_status = not current_status
        db.save_user_settings(
            user_id=message.from_user.id,
            favorite_team=settings['favorite_team'] if settings else None,
            favorite_team_name=settings['favorite_team_name'] if settings else None,
            notifications=new_status
        )

        status_text = "–í–ö–õ–Æ–ß–ï–ù–´ üîî" if new_status else "–í–´–ö–õ–Æ–ß–ï–ù–´ üîï"
        await message.answer(
            f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è {status_text}\n\n"
            f"–í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.",
            reply_markup=get_main_keyboard()
        )

    except Exception as e:
        logging.error(f"Error in notifications: {e}")
        await message.answer(
            "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.",
            reply_markup=get_main_keyboard()
        )


@dp.message(F.text == '‚Ü©Ô∏è –ù–∞–∑–∞–¥')
async def cmd_back_to_main(message: types.Message):
    await cmd_start(message)


@dp.message(F.text == '‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
async def cmd_back_to_settings(message: types.Message):
    await cmd_settings(message)


@dp.message()
async def cmd_unknown(message: types.Message):
    await message.answer(
        "ü§î –Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:",
        reply_markup=get_main_keyboard()
    )


# ============ –ó–ê–ü–£–°–ö –ë–û–¢–ê ============

async def main():
    try:
        logging.info("=" * 50)
        logging.info("üöÄ –ó–ê–ü–£–°–ö –ë–ê–°–ö–ï–¢–ë–û–õ–¨–ù–û–ì–û –ë–û–¢–ê NBA")
        logging.info("=" * 50)

        test_settings = db.get_user_settings(123)
        logging.info(f"‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")

        await dp.start_polling(bot)

    except Exception as e:
        logging.error(f"‚ùå –§–ê–¢–ê–õ–¨–ù–ê–Ø –û–®–ò–ë–ö–ê: {e}")
    finally:
        db.close()
        logging.info("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


if __name__ == '__main__':
    asyncio.run(main())
